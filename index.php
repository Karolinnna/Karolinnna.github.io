<?php
// ------------------------------------------------------------
// index.php — простий роутер з авторизацією та редиректами
// ------------------------------------------------------------

// ------------------------------------------------------------
// 1) Демонстраційні облікові дані користувача
//    !!! У реальному проекті використовуйте password_hash() !!!
// ------------------------------------------------------------
$auth = [
    "login"    => "user",
    "password" => "123456",
];

session_start(); // запуск сесії

// ------------------------------------------------------------
// Обробка виходу з облікового запису (?logout=1)
// ------------------------------------------------------------
if (isset($_GET['logout'])) {
    session_unset();
    session_destroy();
    setcookie('login', '', time() - 3600, '/');

    // Після виходу — редирект на /login
    header("Location: /login");
    exit;
}

// ------------------------------------------------------------
// 2) Перевірка: чи користувач уже авторизований
// ------------------------------------------------------------
$isAuthenticated = false;
if (isset($_SESSION['login']) || isset($_COOKIE['login'])) {
    $isAuthenticated = true;
}


// ------------------------------------------------------------
// 3) Обробка POST-запиту — спроба авторизації
// ------------------------------------------------------------
if ($_SERVER["REQUEST_METHOD"] === "POST") {

    if (isset($_POST["login"], $_POST["password"])) {
        $login = trim($_POST["login"]);
        $password = trim($_POST["password"]);

        // Якщо введено правильні дані
        if ($login === $auth['login'] && $password === $auth['password']) {

            // Успішна авторизація:
            $_SESSION['login'] = $login;
            setcookie('login', $login, time() + 10000, '/');

            // Редирект на головну
            header("Location: /");
            exit;

        } else {
            // Невдала авторизація:
            // 1. Записуємо помилку в сесію
            $_SESSION['error_message'] = "User not found. (Неправильний логін або пароль.)";
            
            // 2. Редирект назад на сторінку авторизації (для відображення помилки)
            header("Location: /login");
            exit;
        }
    }
}

// ------------------------------------------------------------
// 4) Таблиця маршрутів
// ------------------------------------------------------------
$routes = [
    "/"          => ["title" => "ГОЛОВНА",      "file" => "home.php"],
    "/login"     => ["title" => "АВТОРИЗАЦІЯ",  "file" => "login.php"],
];

// ------------------------------------------------------------
// 5) Отримуємо шлях (URI)
// ------------------------------------------------------------
$path = parse_url($_SERVER['REQUEST_URI'] ?? '/', PHP_URL_PATH);
if ($path === null || $path === false) {
    $path = '/';
}

// Нормалізація
$path = rtrim($path, '/');
if ($path === '') {
    $path = '/';
}


// ------------------------------------------------------------
// 6) Якщо користувач авторизований — не пускаємо на /login
// ------------------------------------------------------------
if ($isAuthenticated && in_array($path, ['/login'])) {
    header("Location: /");
    exit;
}


// ------------------------------------------------------------
// 7) Пошук маршруту і підключення відповідного файлу
// ------------------------------------------------------------
if (array_key_exists($path, $routes)) {

    $title = $routes[$path]['title'] ?? 'Сторінка';
    $file  = __DIR__ . DIRECTORY_SEPARATOR . 'Pages' . DIRECTORY_SEPARATOR . $routes[$path]['file'];

    if (is_file($file)) {
        $currentPath = $path;
        $GLOBALS['currentPath'] = $path;
        include $file;
        exit;
    } else {
        // Якщо файл сторінки не знайдено — помилка 500
        http_response_code(500);
        $file500 = __DIR__ . DIRECTORY_SEPARATOR . 'Pages' . DIRECTORY_SEPARATOR . '500.php';
        include $file500;
        exit;
    }
}

// ------------------------------------------------------------
// 8) Якщо маршруту не існує — показуємо сторінку 404
// ------------------------------------------------------------
http_response_code(404);
$title = "Сторінка не знайдена";

$file404 = __DIR__ . DIRECTORY_SEPARATOR . 'Pages' . DIRECTORY_SEPARATOR . '404.php';

if (is_file($file404)) {
    include $file404;
    exit;
} else {
    echo "<h1>404</h1><p>Сторінку не знайдено.</p>";
    exit;
}